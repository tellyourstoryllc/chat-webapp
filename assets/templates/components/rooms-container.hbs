{{#with this as roomsContainer}}
  <div class='room-container'>
    {{#if activeRoom}}
      <div class='room-info'>
        {{#link-to 'rooms.room' activeRoom classNames='room-avatar-permalink'}}
          <img {{bind-attr src='activeRoom.avatarUrl'}} class='medium-avatar-image'>
        {{/link-to}}
        <div class='room-name-info-container'>
          {{#link-to 'rooms.room' activeRoom classNames='room-permalink'}}{{activeRoom.name}}{{/link-to}}
          {{#if roomsContainer.showSetTopicLink}}
            <a href='#' {{action 'editTopic' target=roomsContainer}} class='edit-topic-link'><nobr>Set Topic</nobr></a>
          {{/if}}
        </div>
        {{#if roomsContainer.showTopicRow}}
          <div class='room-info-cell topic-cell'>
            <div class='topic-container'>
              {{#if roomsContainer.isEditingTopic}}
                <form class='edit-topic-form'>
                  {{input type='text' value=roomsContainer.newRoomTopic
                    class='edit-topic'
                    placeholder='New Topic' maxlength='160'}}
                  <button type='submit' {{action 'saveTopic' target=roomsContainer}} class='save-topic-button'>Save</button>
                  <a href='#' {{action 'cancelEditingTopic' target=roomsContainer}} class='edit-topic-link'>Cancel</a>
                </form>
              {{else}}
                <div class='topic-text'>
                  {{activeRoom.topic}}
                  <a href='#' {{action 'editTopic' target=roomsContainer}} class='edit-topic-link'>Edit</a>
                </div>
              {{/if}}
            </div>
          </div>
        {{/if}}
        <div class='clearfix'></div>
      </div>

      {{#unless activeRoom.isCurrentUserMember}}
        <div class='room-alert-content'>
          <div class='room-alert-message'>
            <div>You don't have permission to enter this room.</div>
            <div class='subtitle'>These members are inside:</div>
          </div>
          <div class='members-preview'>
            {{#each user in roomsContainer.roomAlphabeticMembers}}
              <div class='member-preview'>
                {{room-avatar room=user showStatus=false alwaysShowAvatar=true}}
                <span class='username'>{{user.name}}</span>
              </div>
            {{/each}}
            {{#if roomsContainer.roomNumberMoreMembers}}
              and {{roomsContainer.roomNumberMoreMembers}} more.
            {{/if}}
          </div>
        </div>
      {{/unless}}

    {{/if}}

    {{#each rooms}}
      {{#if associationsLoaded}}
        {{#view App.RoomMessagesView roomBinding='this' roomsBinding='roomsContainer.rooms'}}
          {{#with view as messagesView}}
            <div {{bind-attr class=':messages messagesView.isCurrentlyViewingRoom:active:inactive messagesView.isRoomBeforeCursor:before-cursor:after-cursor'}}>
              <div {{bind-attr class=':loading-more-messages isLoadingEarlierMessages::hidden'}}>
                Loading...
              </div>

              {{#each message in messages}}
                <div {{bind-attr class=':message message.sentByClassName message.isSentByCurrentUser:sent-by-you message.isSystemMessage:system-message'}}
                  {{bind-attr data-message-id='message.id'}}>
                  <div class='message-table'>
                    <div class='sender-cell'>
                      <div class='sender'>
                        {{message.user.name}}
                      </div>
                    </div>
                    <div class='body-cell'>
                      <span class='status'>
                        {{#if message.isSaving}}Sending...{{/if}}
                        {{#if message.isError}}
                          <span class='error'>{{message.errorMessage}}</span>
                        {{/if}}
                        {{compact-timestamp-element message.createdAt classNames='timestamp'}}
                      </span>

                      {{! Passing attachmentUrl so that this re-renders when it changes. }}
                      {{messageAttachmentDisplay message
                        attachmentUrlBinding=message.attachmentUrl}}

                      <div class='message-body'>{{message.body}}</div>
                    </div>
                    <div class='clearfix'></div>
                  </div>
                </div>
              {{/each}}
            </div>

            {{! Preview thumbnail of the file attached. }}
            <div {{bind-attr class=':attachment-thumbnail messagesView.hasAttachment:has-attachment'}}>
              <span class='remove' title='Remove Attachment' {{action 'removeAttachment' target=roomsContainer}}>
                &times;
              </span>
              {{#if messagesView.attachmentPreviewUrl}}
                <img class='attachment-thumbnail-image' {{bind-attr src='messagesView.attachmentPreviewUrl'}}>
              {{/if}}
              <div class='filename'>{{messagesView.attachmentName}}</div>
            </div>
          {{/with}}
        {{/view}}
      {{/if}}
    {{/each}}

    <div class='connecting-status-bar'>
      Connecting...
    </div>

    <div class='send-message-area'>
      {{actionable-textarea enter-key-down='sendMessage' classNames='send-message-text'
        valueBinding='activeRoom.newMessageText' maxlength='1000' rows='2'
        disabledBinding='roomsContainer.isSendDisabled'
        target=roomsContainer}}
      {{#if doesBrowserSupportAjaxFileUpload}}
        <button type='button' class='send-message-file-button' {{action 'chooseFile' target=roomsContainer}}>
          {{#if activeRoom.newMessageFile}}
            Change
          {{else}}
            Attach
          {{/if}}
        </button>
        <input type='file' class='send-message-file'>
      {{/if}}
      <button type='button' {{action 'sendMessage' target=roomsContainer}}
        {{bind-attr class=':send-button activeRoom.isEncrypted:encrypted-send-button'}}
        {{bind-attr disabled='roomsContainer.isSendDisabled'}}
        >Send</button>
    </div>

    {{message-autocomplete viewName='autocompleteView'
      matchText=roomsContainer.suggestMatchText
      suggestions=roomsContainer.suggestions
      isShowing=roomsContainer.suggestionsShowing
      didSelectSuggestion='didSelectSuggestion'
      target=roomsContainer}}
  </div>
{{/with}}
